<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MyPrefixParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Calculator with JUnit5 and Cucumber tests</a> &gt; <a href="index.source.html" class="el_package">parser</a> &gt; <span class="el_source">MyPrefixParser.java</span></div><h1>MyPrefixParser.java</h1><pre class="source lang-java linenums">package parser;
import calculator.Calculator;
import calculator.values.NumericValue;
import calculator.values.RealValue;
import calculator.values.ComplexValue;
import java.math.BigDecimal;
import java.util.*;
import static parser.TokenizerPrefix.*;

/**
 * The MyPrefixParser class evaluates arithmetic expressions written in prefix notation.
 * It supports nested parentheses, complex numbers, arithmetic operators, and trigonometric functions.
 *
 * The parser processes the expression using a custom tokenizer and handles implicit multiplication,
 * grouping, and multi-argument operator support.
 *
 * Example:
 *   (+ (* (+ [2+3i] [1-1i]) (+ [4+0i] [2+2i])) (- [5+0i] [0+2i]))
 *
 * Author: Hugue
 */

public class MyPrefixParser {

    /** Default constructor */
<span class="nc" id="L26">    public MyPrefixParser() {}</span>

    /** Token list parsed from input */
<span class="nc" id="L29">    List&lt;String&gt; tokens = new ArrayList&lt;&gt;();</span>

    /** Stores last operator parsed (used for implicit operations) */
<span class="nc" id="L32">    private String lastOperator = &quot;&quot;;</span>

    /** Operators collected during parsing */
<span class="nc" id="L35">    List&lt;String&gt; operators = new ArrayList&lt;&gt;();</span>

    /**
     * Evaluates a prefix expression string.
     * Converts input to tokens and parses recursively.
     *
     * @param expression the arithmetic expression
     * @return the result as a NumericValue
     */
    public NumericValue evaluate(String expression) {
        //System.out.println(&quot;prefix expr = &quot;+expression);
<span class="nc bnc" id="L46" title="All 4 branches missed.">        if(expression.charAt(0) != '(' || expression.charAt(expression.length()-1) != ')') {</span>
<span class="nc" id="L47">            expression = &quot;(&quot; + expression + &quot;)&quot;;</span>
        }
<span class="nc" id="L49">        TokenizerPrefix tokenizerPrefix = new TokenizerPrefix(expression.toString().trim());</span>
<span class="nc" id="L50">        tokens= tokenizerPrefix.getTokens();</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">        for (String token : tokens) {</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            if (isOperator(token)) {</span>
<span class="nc" id="L53">                operators.add(token);</span>
            }
<span class="nc" id="L55">        }</span>
        //System.out.println(&quot;[DEBUG] operator restant= &quot; + operators);


        //System.out.println(&quot;Tokens: &quot; + tokenizerPrefix.getTokens());

<span class="nc" id="L61">        NumericValue result = parseExpression(tokenizerPrefix);</span>


<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (tokenizerPrefix.hasNext()) {</span>
<span class="nc" id="L65">            throw new RuntimeException(&quot;Invalid expression: extra tokens remaining &quot; + tokenizerPrefix.getTokens());</span>
        }
<span class="nc" id="L67">        return result;</span>
    }

    /**
     * Entry point to test several example prefix expressions.
     */
    public static void main(String[] args) {
<span class="nc" id="L74">        String exprPrefixWithCommas = &quot;(+(4,5,6),+(7,/(5,2,7)),9)&quot;;;</span>
<span class="nc" id="L75">        String exprPrefixWithoutCommas = &quot;(+ (* (+ [2+3i] [1-1i]) (+ [4+0i] [2+2i])) (- [5+0i] [0+2i]))&quot;;</span>
<span class="nc" id="L76">        ExpressionParser.mycalculator.setUseRadians(false);</span>

<span class="nc" id="L78">        System.out.print(exprPrefixWithCommas + &quot; = &quot;);</span>
<span class="nc" id="L79">        MyPrefixParser myPrefixParser = new MyPrefixParser();</span>
<span class="nc" id="L80">        System.out.println(myPrefixParser.evaluate(exprPrefixWithCommas));</span>
<span class="nc" id="L81">        System.out.println(&quot;\n&quot;);</span>
<span class="nc" id="L82">        System.out.print(exprPrefixWithoutCommas + &quot; = &quot;);</span>
<span class="nc" id="L83">        System.out.println(myPrefixParser.evaluate(exprPrefixWithoutCommas));</span>
<span class="nc" id="L84">    }</span>

    /**
     * Parses a full expression or value recursively.
     * Handles grouping, operators, and functions.
     */
    private NumericValue parseExpression(TokenizerPrefix tokenizerPrefix) {
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (!tokenizerPrefix.hasNext()) throw new RuntimeException(&quot;Unexpected end of expression&quot;);</span>

<span class="nc" id="L93">        String token = tokenizerPrefix.peek();</span>
        //System.out.println(&quot;[DEBUG] peek token = &quot; + token);

<span class="nc bnc" id="L96" title="All 2 branches missed.">        if (token.equals(&quot;(&quot;)) {</span>
<span class="nc" id="L97">            tokenizerPrefix.next(); // consume '('</span>
            //System.out.println(&quot;[DEBUG] found '('&quot;);

<span class="nc bnc" id="L100" title="All 2 branches missed.">            if (!tokenizerPrefix.hasNext()) throw new RuntimeException(&quot;Unexpected end after '('&quot;);</span>

<span class="nc" id="L102">            token = tokenizerPrefix.peek();</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (isOperator(token)) {</span>
<span class="nc" id="L104">                lastOperator = token;</span>
<span class="nc" id="L105">                token = tokenizerPrefix.next(); // consume operator</span>
                //System.out.println(&quot;[DEBUG] operator in group = &quot; + token);
<span class="nc" id="L107">                List&lt;NumericValue&gt; args = parseArguments(tokenizerPrefix);</span>
                //System.out.println(&quot;[DEBUG] args = &quot; + args);
<span class="nc" id="L109">                NumericValue product =new RealValue(0, 10);</span>
                //System.out.println(&quot;[DEBUG] operator in group = &quot; + token);
                //System.out.println(&quot;[DEBUG] operator restant= &quot; + operators);
<span class="nc bnc" id="L112" title="All 2 branches missed.">                if(operators.size()==0)</span>
                {
<span class="nc" id="L114">                    product = args.get(0);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                    for (int i = 1; i &lt; args.size(); i++) {</span>
<span class="nc" id="L116">                        product = product.multiply(args.get(i));</span>
                    }
                    //System.out.println(&quot;[DEBUG] product of values last implicite&quot; + args + &quot; = &quot; + product);

                }
                else {
<span class="nc" id="L122">                    product = applyOperator(token, args);</span>
<span class="nc" id="L123">                    operators.remove(token);</span>
                }

                //System.out.println(&quot;[DEBUG] result of operator &quot; + token + &quot; on &quot; + args + &quot; = &quot; + product);
<span class="nc" id="L127">                return product;</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            } else if (isFunction(token)) {</span>
<span class="nc" id="L129">                token = tokenizerPrefix.next(); // consume function</span>
                //System.out.println(&quot;[DEBUG] function in group = &quot; + token);
<span class="nc" id="L131">                NumericValue arg = parseExpression(tokenizerPrefix);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                if (!tokenizerPrefix.peek().equals(&quot;)&quot;)) throw new RuntimeException(&quot;Expected ')' after function argument&quot;);</span>
<span class="nc" id="L133">                tokenizerPrefix.next(); // consume ')'</span>
<span class="nc" id="L134">                return applyFunction(token, arg);</span>
            } else {
                // Multiplication implicite
<span class="nc" id="L137">                List&lt;NumericValue&gt; values = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                while (tokenizerPrefix.hasNext()) {</span>
<span class="nc" id="L139">                    String next = tokenizerPrefix.peek();</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">                    if (next.equals(&quot;)&quot;)) {</span>
<span class="nc" id="L141">                        tokenizerPrefix.next(); // consume ')'</span>
<span class="nc" id="L142">                        break;</span>
                    }
<span class="nc bnc" id="L144" title="All 2 branches missed.">                    if (next.equals(&quot;,&quot;)) {</span>
<span class="nc" id="L145">                        tokenizerPrefix.next(); // skip comma</span>
<span class="nc" id="L146">                        continue;</span>
                    }
<span class="nc" id="L148">                    values.add(parseExpression(tokenizerPrefix));</span>
<span class="nc" id="L149">                }</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                if (values.isEmpty()) return new RealValue(0, 10);</span>
<span class="nc" id="L151">                NumericValue product =new RealValue(0, 10);</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">                if(lastOperator.isBlank()) {</span>
<span class="nc" id="L153">                    product = values.get(0);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">                    for (int i = 1; i &lt; values.size(); i++) {</span>
<span class="nc" id="L155">                        product = product.multiply(values.get(i));</span>
                    }
                    //System.out.println(&quot;[DEBUG] product of values last implicite&quot; + values + &quot; = &quot; + product);
                }
                else
                {
                    //System.out.println(&quot;[DEBUG] lastOperator&quot; + &quot; = &quot; + lastOperator);
                    //System.out.println(&quot;[DEBUG] values&quot; + &quot; = &quot; + values);
<span class="nc" id="L163">                    product = applyOperator(lastOperator, values);</span>
<span class="nc" id="L164">                    operators.remove(lastOperator);</span>
<span class="nc" id="L165">                    lastOperator = &quot;&quot;;</span>
                    //System.out.println(&quot;[DEBUG] sum of values &quot; + values + &quot; = &quot; + product);

                }
<span class="nc" id="L169">                return product;</span>
            }
        }

<span class="nc bnc" id="L173" title="All 2 branches missed.">        else if (token.equals(&quot;)&quot;)) {</span>
<span class="nc" id="L174">            tokenizerPrefix.next();</span>
<span class="nc" id="L175">            throw new RuntimeException(&quot;Unexpected ')'&quot;);</span>
        }

<span class="nc bnc" id="L178" title="All 2 branches missed.">        else if (isOperator(token)) {</span>
<span class="nc" id="L179">            token = tokenizerPrefix.next();</span>
            //System.out.println(&quot;[DEBUG] operator standalone = &quot; + token);

<span class="nc" id="L182">            List&lt;NumericValue&gt; args = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L183" title="All 4 branches missed.">            if (tokenizerPrefix.hasNext() &amp;&amp; tokenizerPrefix.peek().equals(&quot;(&quot;)) {</span>
<span class="nc" id="L184">                tokenizerPrefix.next(); // consume '('</span>
<span class="nc" id="L185">                args = parseArguments(tokenizerPrefix);</span>
            } else {
<span class="nc" id="L187">                args.add(parseExpression(tokenizerPrefix));</span>
<span class="nc" id="L188">                args.add(parseExpression(tokenizerPrefix));</span>
            }

<span class="nc bnc" id="L191" title="All 2 branches missed.">            if (args.isEmpty()) throw new RuntimeException(&quot;No arguments for operator: &quot; + token);</span>
<span class="nc" id="L192">            NumericValue result = applyOperator(token, args);</span>
            //System.out.println(&quot;[DEBUG] result of operator &quot; + token + &quot; on &quot; + args + &quot; = &quot; + result);
<span class="nc" id="L194">            operators.remove(token);</span>
<span class="nc" id="L195">            return result;</span>
        }

<span class="nc bnc" id="L198" title="All 2 branches missed.">        else if (isFunction(token)) {</span>
<span class="nc" id="L199">            token = tokenizerPrefix.next();</span>
            //System.out.println(&quot;[DEBUG] function standalone = &quot; + token);
<span class="nc" id="L201">            NumericValue arg = parseExpression(tokenizerPrefix);</span>
<span class="nc" id="L202">            return applyFunction(token, arg);</span>
        }

        else {
<span class="nc" id="L206">            token = tokenizerPrefix.next();</span>
            // System.out.println(&quot;[DEBUG] raw token = &quot; + token);

<span class="nc bnc" id="L209" title="All 2 branches missed.">            if (token.startsWith(&quot;[&quot;)) {</span>
<span class="nc" id="L210">                return parseComplex(token);</span>
            }

            try {
<span class="nc" id="L214">                return new RealValue(new BigDecimal(token), 10);</span>
<span class="nc" id="L215">            } catch (NumberFormatException e) {</span>
<span class="nc" id="L216">                throw new RuntimeException(&quot;Invalid number format: &quot; + token);</span>
            }
        }
    }

    /** Parses a list of arguments within parentheses */
    private List&lt;NumericValue&gt; parseArguments(TokenizerPrefix tokenizerPrefix) {
<span class="nc" id="L223">        List&lt;NumericValue&gt; args = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">        while (tokenizerPrefix.hasNext()) {</span>
<span class="nc" id="L225">            String next = tokenizerPrefix.peek();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">            if (next.equals(&quot;)&quot;)) {</span>
<span class="nc" id="L227">                tokenizerPrefix.next(); // consume ')'</span>
<span class="nc" id="L228">                break;</span>
            }
<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (next.equals(&quot;,&quot;)) {</span>
<span class="nc" id="L231">                tokenizerPrefix.next(); // skip ','</span>
<span class="nc" id="L232">                continue;</span>
            }
<span class="nc" id="L234">            args.add(parseExpression(tokenizerPrefix));</span>
<span class="nc" id="L235">        }</span>
<span class="nc" id="L236">        return args;</span>
    }

    /** Parses a complex number literal of the form [a+bi] */
    private NumericValue parseComplex(String token) {
<span class="nc bnc" id="L241" title="All 4 branches missed.">        if (!token.startsWith(&quot;[&quot;) || !token.endsWith(&quot;]&quot;)) throw new RuntimeException(&quot;Invalid complex number format: &quot; + token);</span>
<span class="nc" id="L242">        token = token.substring(1, token.length() - 1);</span>
<span class="nc" id="L243">        token = token.replace(&quot;-&quot;, &quot;+-&quot;);</span>
<span class="nc" id="L244">        String[] parts = token.split(&quot;\\+&quot;);</span>
<span class="nc" id="L245">        double real = 0;</span>
<span class="nc" id="L246">        double imag = 0;</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">        for (String part : parts) {</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            if (part.isEmpty()) continue;</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">            if (part.endsWith(&quot;i&quot;)) {</span>
<span class="nc" id="L250">                imag += Double.parseDouble(part.substring(0, part.length() - 1));</span>
            } else {
<span class="nc" id="L252">                real += Double.parseDouble(part);</span>
            }
        }
<span class="nc" id="L255">        return new ComplexValue(real, imag);</span>
    }

    /** Checks whether a token is an operator */
    private static boolean isOperator(String token) {
<span class="nc" id="L260">        return Arrays.asList(&quot;+&quot;, &quot;-&quot;, &quot;*&quot;, &quot;/&quot;).contains(token);</span>
    }

    /** Checks whether a token is a function */
    private static boolean isFunction(String token) {
<span class="nc" id="L265">        return Arrays.asList(&quot;sin&quot;, &quot;cos&quot;, &quot;tan&quot;).contains(token);</span>
    }

    /** Applies a function to the given argument */
    private NumericValue applyFunction(String func, NumericValue arg) {
<span class="nc" id="L270">        double value = Double.parseDouble(arg.toString());</span>
<span class="nc" id="L271">        Calculator c = ExpressionParser.mycalculator;</span>
<span class="nc bnc" id="L272" title="All 4 branches missed.">        switch (func) {</span>
<span class="nc" id="L273">            case &quot;sin&quot;: return new RealValue(c.sin(value), 10);</span>
<span class="nc" id="L274">            case &quot;cos&quot;: return new RealValue(c.cos(value), 10);</span>
<span class="nc" id="L275">            case &quot;tan&quot;: return new RealValue(c.tan(value), 10);</span>
<span class="nc" id="L276">            default: throw new RuntimeException(&quot;Unknown function: &quot; + func);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>